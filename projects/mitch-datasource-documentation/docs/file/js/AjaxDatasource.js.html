<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">js/AjaxDatasource.js | mitch-datasource-documentation</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Documentation for mitch-datasource"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="mitch-datasource-documentation"><meta property="twitter:description" content="Documentation for mitch-datasource"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/deltoss/mitch-datasource"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/AjaxDatasource.js~AjaxDatasource.html">AjaxDatasource</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/ArrayDatasource.js~ArrayDatasource.html">ArrayDatasource</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/DatasourceBase.js~DatasourceBase.html">DatasourceBase</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/QueryBuilder.js~QueryBuilder.html">QueryBuilder</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-SortCallback">SortCallback</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-SortCallback">SortCallback</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-QueryStringOptions">QueryStringOptions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-SerialiseToQueryObjectCallback">SerialiseToQueryObjectCallback</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-SerialiseToQueryStringCallback">SerialiseToQueryStringCallback</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">js/AjaxDatasource.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import axios from &apos;axios&apos;;
import DatasourceBase from &apos;./DatasourceBase&apos;;
import QueryBuilder from &apos;./QueryBuilder&apos;;

/**
 * Datasource to retrieve and manage
 * data from a remote endpoint.
 *
 * @example &lt;caption&gt;Basic Usage&lt;/caption&gt;
 *
 * import { AjaxDatasource } from &apos;mitch-datasource&apos;;
 *
 * async function exampleAsyncFunction() {
 *   let datasource = new AjaxDatasource({
 *     ajax: &apos;https://path/to/remote/endpoint&apos;
 *   });
 *   await datasource.update();
 *   console.log(`First page of data: ${JSON.stringify(datasource.data)}`);
 * }
 * exampleAsyncFunction();
 *
 * @example &lt;caption&gt;Basic Usage with Options Object&lt;/caption&gt;
 *
 * import { AjaxDatasource } from &apos;mitch-datasource&apos;;
 *
 * async function exampleAsyncFunction() {
 *   let datasource = new AjaxDatasource({
 *     ajax: {
 *       // Note pagination/sorting/filtering doesn&apos;t
 *       // work with this fake endpoint, as even when
 *       // we send the datasource parameters, the
 *       // remote endpoint won&apos;t actually vary
 *       // the returned dataset.
 *       url: &apos;https://jsonplaceholder.typicode.com/posts&apos;,
 *       method: &apos;get&apos;,
 *       // ... Other Axios options
 *       // `mapper` is a custom option unique to the datasource package,
 *       // it&apos;s not actually part of Axios
 *       mapper: function(response) {
 *         return {
 *           data: response.data,
 *           total: response.data.length,
 *         }
 *       }
 *     }
 *   });
 *   await datasource.update();
 *   console.log(`First page of data: ${JSON.stringify(datasource.data)}`);
 * }
 * exampleAsyncFunction();
 *
 * @example &lt;caption&gt;Basic Usage with Function&lt;/caption&gt;
 *
 * import { AjaxDatasource } from &apos;mitch-datasource&apos;;
 *
 * async function exampleAsyncFunction() {
 *   let datasource = new AjaxDatasource({
 *     ajax: async function(queryBuilder) {
 *       return await mockAjaxCall(queryBuilder);
 *     }
 *   });
 *   await datasource.update();
 *   console.log(`First page of data: ${JSON.stringify(datasource.data)}`);
 * }
 * exampleAsyncFunction();
 */
class AjaxDatasource extends DatasourceBase {
  /**
   * The constructor, taking in an options object.
   * For more passable options, see
   * {@link DatasourceBase#constructor}
   * @override
   * @param {String|Function|Object} options.ajax
   * Defines the behavior of the AJAX call.
   * If a string, remote endpoint to contact.
   * If a function, it&apos;ll call the function
   * when data is requested. If an object,
   * will use the object to configure
   * the AJAX call.
   */
  constructor(options = {}) {
    let { ajax } = options;
    if (ajax &amp;&amp; typeof ajax === &apos;object&apos;) {
      ajax = {
        ...AjaxDatasource.prototype.defaults.ajax,
        ...ajax,
      };
    }

    const mergedOptions = {
      ...AjaxDatasource.prototype.defaults,
      ...options,
      ajax,
    };

    super(mergedOptions);

    /**
     * The total amount of data items to page through.
     *
     * @access private
     * @type {Number}
     */
    this._total = null;

    /**
     * The array of data items.
     *
     * @access private
     * @type {?Array}
     */
    this._data = null;

    if (mergedOptions.queryBuilder instanceof QueryBuilder) {
      /**
       * The query builder which constructs
       * either the query object to pass to
       * post/delete/put requests, or the
       * query string to pass to get
       * requests.
       *
       * @access public
       * @type {QueryBuilder}
       */
      this.queryBuilder = mergedOptions.queryBuilder;
    } else if (mergedOptions.queryBuilder) {
      this.queryBuilder = new QueryBuilder(mergedOptions.queryBuilder);
    }

    /**
     * Property defining the behavior
     * of the AJAX call.
     * If a string, remote endpoint
     * to contact. If a function,
     * it&apos;ll call the function when
     * data is requested. If an object,
     * will use the object to configure
     * the AJAX call.
     *
     * @access public
     * @type {String|Function|Object}
     */
    this.ajax = mergedOptions.ajax;
  }

  /**
   * Performs an AJAX call.
   *
   * @access private
   * @param {Object} axiosOptions Ajax options object for axios
   * @param {String} axiosOptions.url Url to remote endpoint to ajax for.
   * @param {String} axiosOptions.method The AJAX method, i.e. &apos;get&apos;, &apos;post&apos;, etc.
   * @return {Promise} Returns the axios promise object, containing
   *                   the response from remote endpoint.
   */
  _ajaxCall({ url, method }) {
    const actualAxiosOptions = { url, method };
    actualAxiosOptions.method = actualAxiosOptions.method
      ? actualAxiosOptions.method.toLowerCase()
      : actualAxiosOptions.method;
    if (actualAxiosOptions.method === &apos;get&apos;) {
      actualAxiosOptions.url = `${actualAxiosOptions.url}?${this.queryBuilder.getQueryString(this)}`;
    } else {
      actualAxiosOptions.data = this.queryBuilder.getQueryObject(this);
    }
    return axios(actualAxiosOptions);
  }

  /**
   * Builds an AJAX handler function.
   * @access private
   * @return {Function} A callback function which performs
   *                    the actual ajax operation.
   */
  _buildAjaxHandler() {
    const ajaxHandler = {
      function: () =&gt; this.ajax.call(this, this.queryBuilder),
      string: () =&gt; {
        const url = this.ajax;
        return this._ajaxCall({
          url,
          method: &apos;get&apos;,
        });
      },
      object: () =&gt; {
        this.ajax.method = this.ajax.method || &apos;get&apos;;
        return this._ajaxCall(this.ajax);
      },
    };
    const ajaxObjectType = typeof this.ajax;
    const actualAjaxHandler = ajaxHandler[ajaxObjectType];
    if (!actualAjaxHandler) {
      throw new Error(`Does not support provided ajax object of type ${ajaxObjectType}`);
    }
    return actualAjaxHandler;
  }

  /**
   * Overrides for DatasourceBase
   */

  /**
   * @inheritdoc
   * @override
   * @type {Number}
   */
  get total() {
    return this._total;
  }

  /**
   * @inheritdoc
   * @override
   * @type {?Array}
   */
  get data() {
    return this._data;
  }

  /**
   * @inheritdoc
   * @override
   */
  async _update() {
    const ajaxHandler = this._buildAjaxHandler();
    const requestStartArgs = {
      sender: this,
      prevented: false,
      preventDefault() {
        requestStartArgs.prevented = true;
      },
      ajaxHandler,
    };
    this.emit(&apos;requeststart&apos;, requestStartArgs);
    if (requestStartArgs.prevented) {
      return null;
    }
    const response = await requestStartArgs.ajaxHandler.call(this);
    this.emit(&apos;requestend&apos;, {
      sender: this,
      response,
    });
    // If not provided an object, use the default mapper
    const mapper = this.ajax.mapper || AjaxDatasource.prototype.defaults.ajax.mapper;
    const mappedObject = mapper.call(this, response);
    this._data = mappedObject.data;
    this._total = mappedObject.total;
    return response;
  }
}

AjaxDatasource.prototype.defaults = {
  queryBuilder: {},
  // ajax can be an object, function, or even a simple string
  ajax: { // Axios options object
    // Maps the response to return the data in an expected format
    mapper(response) {
      return {
        data: response.data,
        total: response.total,
      };
    },
  },
};

export default AjaxDatasource;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
