<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">js/QueryBuilder.js | mitch-datasource</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Datasource component to generalise the way to perform data-related operations such as paging, filtering, sorting, etc."><meta property="twitter:card" content="summary"><meta property="twitter:title" content="mitch-datasource"><meta property="twitter:description" content="Datasource component to generalise the way to perform data-related operations such as paging, filtering, sorting, etc."></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/deltoss/mitch-datasource"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/AjaxDatasource.js~AjaxDatasource.html">AjaxDatasource</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/ArrayDatasource.js~ArrayDatasource.html">ArrayDatasource</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/DatasourceBase.js~DatasourceBase.html">DatasourceBase</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/QueryBuilder.js~QueryBuilder.html">QueryBuilder</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-SortCallback">SortCallback</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-SortCallback">SortCallback</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-MultiColumnSearchArgs">MultiColumnSearchArgs</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-MultiColumnSortArgs">MultiColumnSortArgs</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-QueryStringOptions">QueryStringOptions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-SerialiseToQueryObjectCallback">SerialiseToQueryObjectCallback</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-SerialiseToQueryStringCallback">SerialiseToQueryStringCallback</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">js/QueryBuilder.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import queryString from &apos;query-string&apos;;

function hasObjectInArray(arr) {
  for (let i = 0; i &lt; arr.length; i += 1) {
    if (typeof arr[i] === &apos;object&apos;) {
      return true;
    }
  }
  return false;
}

/**
 * Using a datasource object, it builds
 * the data object for AJAX post requests,
 * or the query string for AJAX get requests
 *
 * @example &lt;caption&gt;With AJAX Datasource&lt;/caption&gt;
 * let datasource = new AjaxDatasource({
 *   // ...
 *   queryBuilder: new QueryBuilder({
 *     // ...
 *   })
 * });
 * @example &lt;caption&gt;With Adding to Defaults&lt;/caption&gt;
 * let datasource = new AjaxDatasource({
 *   // ...
 *   queryBuilder: new QueryBuilder({
 *     // ...
 *     serialiseToQueryObject(datasource) {
 *       // Calls the original default serialiser
 *       let queryObject = QueryBuilder.prototype
 *                         .defaults.serialiseToQueryObject(datasource);
 *       // ... Do your additional operations
 *     },
 *     serialiseToQueryString(objectToSerialise) {
 *       // Calls the original default serialiser
 *       let queryString = QueryBuilder.prototype
 *                         .defaults.serialiseToQueryString(objectToSerialise);
 *       // ... Do your additional operations
 *     },
 *     queryStringOptions: {
 *       // Keep the default options
 *       ...QueryBuilder.prototype.defaults.queryStringOptions,
 *       // ... Put additional options here. It&apos;ll override default options
 *       // For available options, check the docs for QueryBuilder constructor
 *     }
 *   })
 * });
 * @example &lt;caption&gt;With Extra Parameter for GET/POST Request&lt;/caption&gt;
 * let datasource = new AjaxDatasource({
 *   // ...
 *   queryBuilder: new QueryBuilder({
 *     serialiseToQueryObject(datasource) {
 *       // Calls the original converter
 *       let queryObject = QueryBuilder.prototype.defaults.serialiseToQueryObject(datasource);
 *       queryObject[&apos;extraGreetingData&apos;] = &apos;HelloWorld&apos;;
 *       return queryObject;
 *     },
 *   })
 * });
 */
class QueryBuilder {
  /**
   * Callback function that converts a datasource
   * into a query object (which in turn can be
   * converted to query string).
   *
   * @typedef {Function} SerialiseToQueryObjectCallback
   * @param {DatasourceBase} datasource
   * The datasource to convert to a query object.
   * @returns {Object} The query object.
   */

  /**
   * Callback function which serialises the
   * query string object to the query string.
   * By default, it uses the `query-string` package
   * to convert the query string object to query
   * string.
   *
   * @typedef {Function} SerialiseToQueryStringCallback
   * @param {Object} objectToSerialise
   * The object to serialise to query string.
   * By default, it&apos;s the query object.
   * @returns {String} The query string.
   */

  /**
   * The query string options object that
   * contains configuration and settings
   * to affect the process of converting
   * the datasource to a query string.
   *
   * For a full list of available options
   * and settings, see {@link https://www.npmjs.com/package/query-string#stringifyobject-options}
   *
   * @typedef {Object} QueryStringOptions
   */

  /**
   * @param {Object} [options] The options object.
   * @param {SerialiseToQueryObjectCallback} [options.serialiseToQueryObject]
   * Function which converts a datasource
   * into a query object (which in turn can
   * be converted to query string).
   * @param {QueryStringOptions} [options.queryStringOptions]
   * See {@link QueryStringOptions}
   * @param {SerialiseToQueryStringCallback} [options.serialiseToQueryString]
   * The function which serialises the
   * query string object to the query string.
   */
  constructor(options = {}) {
    const mergedOptions = {
      ...QueryBuilder.prototype.defaults,
      ...options,
    };
    /**
     * See {@link SerialiseToQueryObjectCallback}
     *
     * @access public
     * @type {SerialiseToQueryObjectCallback}
     */
    this.serialiseToQueryObject = mergedOptions.serialiseToQueryObject;

    /**
     * See {@link QueryStringOptions}
     *
     * @access public
     * @type {QueryStringOptions}
     */
    this.queryStringOptions = mergedOptions.queryStringOptions;

    /**
     * If you need to change the behavior of the
     * query string, then you should first check
     * {@link QueryBuilder#queryStringOptions}
     *
     * For more information, see {@link SerialiseToQueryStringCallback}
     *
     * @access public
     * @type {SerialiseToQueryStringCallback}
     */
    this.serialiseToQueryString = mergedOptions.serialiseToQueryString;
  }

  /**
   * Serialises a datasource into
   * an object and returns that object.
   * That object is passed as data as
   * part of AJAX post requests.
   *
   * @param {DatasourceBase} datasource The datasource.
   * @access public
   * @returns {Object} The query object.
   */
  getQueryObject(datasource) {
    if (!this.serialiseToQueryObject) {
      throw new Error(&apos;serialiseToQueryObject must be specified and cannot be undefined or null.&apos;);
    }
    return this.serialiseToQueryObject.call(this, datasource);
  }

  /**
   * Serialises a datasource into
   * a query string and returns that string.
   * This string is passed as data as
   * part of AJAX get requests.
   *
   * @param {DatasourceBase} datasource The datasource.
   * @access public
   * @returns {String} The query string.
   */
  getQueryString(datasource) {
    const objectToSerialise = { ...this.getQueryObject(datasource) };
    if (this.serialiseToQueryString) {
      return this.serialiseToQueryString.call(this, objectToSerialise);
    }
    throw new Error(&apos;Query string serialiser is specified as null or undefined in the options.&apos;);
  }
}

QueryBuilder.prototype.defaults = {
  // Properties to include in the
  // serialisation to GET query string,
  // or when constructing the
  // data object.
  // By default, it only include
  // primitive properties, ignoring
  // objects, arrays and certain properties.
  serialiseToQueryObject(datasource) {
    const entries = Object.entries(datasource);
    const filteredEntries = entries.filter((entry) =&gt; {
      const key = entry[0];
      if (key.indexOf(&apos;_&apos;) === 0 || key === &apos;loading&apos;) { // Ignore &apos;private&apos; properties and specified properties
        return false;
      }
      // Ignore properties that shouldn&apos;t be serialised,
      // i.e. properties that configures the serialisation
      // itself.
      const value = entry[1];
      if (value === null) { // Don&apos;t serialise null values
        return false;
      }
      if (key === &apos;queryBuilder&apos; || key === &apos;ajax&apos;) {
        return false;
      }
      return true;
    });
    const queryObject = {
      // Computed getters doesn&apos;t get included in ES6 spread syntax,
      // so we manually include the necessary one below.
      page: datasource.page,
    };
    filteredEntries.forEach((entry) =&gt; {
      const key = entry[0];
      const value = entry[1];
      queryObject[key] = value;
    });
    return queryObject;
  },
  /* eslint-disable no-param-reassign */
  serialiseToQueryString(objectToSerialise) {
    Object.keys(objectToSerialise).forEach((prop) =&gt; {
      if (Array.isArray(objectToSerialise[prop]) &amp;&amp; hasObjectInArray(objectToSerialise[prop])) {
        for (let i = 0; i &lt; objectToSerialise[prop].length; i += 1) {
          objectToSerialise[prop][i] = JSON.stringify(objectToSerialise[prop][i]);
        }
      } else if (typeof objectToSerialise[prop] === &apos;object&apos;) {
        objectToSerialise[prop] = JSON.stringify(objectToSerialise[prop]);
      }
    });
    return queryString.stringify(objectToSerialise, this.queryStringOptions);
  },
  /* eslint-enable no-param-reassign */
  queryStringOptions: {
    // By default, uses NPM query
    // string package to serialise
    // to query string. For full list
    // of options, see:
    //   https://www.npmjs.com/package/query-string#stringifyobject-options
    // If you specified a query string serialiser,
    // this options can optionally be used.
    arrayFormat: &apos;bracket&apos;,
  },
};

export default QueryBuilder;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
